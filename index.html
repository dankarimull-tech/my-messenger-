<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0e1621">
<style>
:root {
  --bg1: #0e1621; --bg2: #17212b; --bg3: #202b36;
  --bg-hover: #1e2c3a; --bg-active: #2b5278;
  --text1: #f5f5f5; --text2: #8b9bab; --text3: #5a6a78;
  --accent: #5288c1; --accent2: #3a6fa0;
  --bubble-me: #2b5278; --bubble-other: #182533;
  --online: #4dcd5e; --unread-bg: #5288c1;
  --danger: #e05555; --border: #1c2a3a;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:var(--bg1); color:var(--text1); height:100vh; overflow:hidden; }
input, button, textarea { font-family: inherit; }
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--bg3); border-radius:3px; }

/* ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê */
.screen { display:none; height:100vh; }
.screen.active { display:flex; }
#auth-screen { justify-content:center; align-items:center; background:var(--bg2); }
.auth-box { background:var(--bg1); padding:40px; border-radius:16px; width:380px; max-width:92vw; text-align:center; border:1px solid var(--border); }
.auth-box h1 { font-size:52px; margin-bottom:6px; }
.auth-box h2 { color:var(--text2); font-weight:400; font-size:18px; margin-bottom:28px; }
.auth-input { width:100%; padding:14px 16px; margin:6px 0; border-radius:10px; border:2px solid var(--border); background:var(--bg2); color:var(--text1); font-size:15px; outline:none; transition:.2s; }
.auth-input:focus { border-color:var(--accent); }
.auth-btn { width:100%; padding:14px; margin-top:14px; border-radius:10px; border:none; background:var(--accent); color:#fff; font-size:16px; font-weight:600; cursor:pointer; transition:.2s; }
.auth-btn:hover { background:var(--accent2); }
.auth-link { margin-top:16px; color:var(--accent); cursor:pointer; font-size:14px; }
.auth-link:hover { text-decoration:underline; }
.auth-error { color:var(--danger); margin-top:12px; font-size:13px; min-height:20px; }

/* ‚ïê‚ïê‚ïê APP LAYOUT ‚ïê‚ïê‚ïê */
#app-screen { flex-direction:row; }
.sidebar { width:340px; min-width:340px; background:var(--bg2); display:flex; flex-direction:column; border-right:1px solid var(--border); }
.chat-panel { flex:1; display:flex; flex-direction:column; display:none; }
.chat-panel.active { display:flex; }
.no-chat { flex:1; display:flex; justify-content:center; align-items:center; flex-direction:column; color:var(--text3); gap:12px; }
.no-chat.hidden { display:none; }
.no-chat-icon { font-size:64px; }

/* ‚ïê‚ïê‚ïê SIDEBAR HEADER ‚ïê‚ïê‚ïê */
.side-header { padding:12px 16px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); min-height:56px; }
.side-header .my-name { font-weight:600; font-size:16px; }
.side-header .logout-btn { background:none; border:none; color:var(--text3); cursor:pointer; font-size:20px; padding:6px; border-radius:8px; }
.side-header .logout-btn:hover { background:var(--bg3); color:var(--danger); }

/* ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê */
.search-box { padding:8px 12px; }
.search-input { width:100%; padding:10px 14px 10px 36px; border-radius:10px; border:none; background:var(--bg1); color:var(--text1); font-size:14px; outline:none; }
.search-wrap { position:relative; }
.search-icon { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--text3); font-size:14px; pointer-events:none; }

/* ‚ïê‚ïê‚ïê CONVERSATIONS LIST ‚ïê‚ïê‚ïê */
.conv-list { flex:1; overflow-y:auto; }
.conv-item { display:flex; align-items:center; padding:10px 16px; cursor:pointer; gap:12px; transition:.15s; }
.conv-item:hover { background:var(--bg-hover); }
.conv-item.active { background:var(--bg-active); }
.avatar { width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:600; color:#fff; flex-shrink:0; position:relative; }
.avatar.small { width:40px; height:40px; font-size:17px; }
.avatar .online-dot { position:absolute; bottom:1px; right:1px; width:12px; height:12px; background:var(--online); border-radius:50%; border:2px solid var(--bg2); }
.conv-info { flex:1; min-width:0; }
.conv-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:3px; }
.conv-name { font-weight:600; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.conv-time { font-size:12px; color:var(--text3); flex-shrink:0; margin-left:8px; }
.conv-bottom { display:flex; justify-content:space-between; align-items:center; }
.conv-last { font-size:13px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; }
.conv-last .from-me { color:var(--accent); }
.conv-unread { background:var(--unread-bg); color:#fff; font-size:12px; font-weight:600; padding:2px 7px; border-radius:12px; margin-left:8px; flex-shrink:0; }
.search-results { flex:1; overflow-y:auto; }
.search-results .conv-item .start-label { font-size:13px; color:var(--accent); }

/* ‚ïê‚ïê‚ïê CHAT HEADER ‚ïê‚ïê‚ïê */
.chat-header { padding:10px 16px; display:flex; align-items:center; gap:12px; border-bottom:1px solid var(--border); background:var(--bg2); min-height:56px; }
.back-btn { display:none; background:none; border:none; color:var(--text2); font-size:22px; cursor:pointer; padding:4px 8px; border-radius:8px; }
.back-btn:hover { background:var(--bg3); }
.chat-header-info { flex:1; }
.chat-header-name { font-weight:600; font-size:15px; }
.chat-header-status { font-size:13px; color:var(--text3); }
.chat-header-status.online { color:var(--online); }

/* ‚ïê‚ïê‚ïê MESSAGES ‚ïê‚ïê‚ïê */
.messages { flex:1; overflow-y:auto; padding:12px 20px; display:flex; flex-direction:column; gap:4px; }
.msg { display:flex; flex-direction:column; max-width:70%; animation:msgIn .2s ease; }
@keyframes msgIn { from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none} }
.msg.mine { align-self:flex-end; }
.msg.other { align-self:flex-start; }
.msg-bubble { padding:8px 12px; border-radius:12px; position:relative; word-wrap:break-word; line-height:1.45; }
.msg.mine .msg-bubble { background:var(--bubble-me); border-bottom-right-radius:4px; }
.msg.other .msg-bubble { background:var(--bubble-other); border-bottom-left-radius:4px; }
.msg-author { font-size:12px; color:var(--accent); font-weight:600; margin-bottom:2px; }
.msg-text { font-size:14.5px; white-space:pre-wrap; }
.msg-media { max-width:320px; max-height:320px; border-radius:8px; cursor:pointer; margin:4px 0; display:block; }
.msg-video { max-width:320px; border-radius:8px; margin:4px 0; }
.msg-file { display:flex; align-items:center; gap:8px; padding:8px 0; cursor:pointer; text-decoration:none; color:var(--text1); }
.msg-file-icon { font-size:28px; }
.msg-file-info { flex:1; }
.msg-file-name { font-size:14px; font-weight:500; }
.msg-file-size { font-size:12px; color:var(--text3); }
.msg-footer { display:flex; justify-content:flex-end; align-items:center; gap:4px; margin-top:2px; }
.msg-time { font-size:11px; color:var(--text3); }
.msg.mine .msg-time { color:rgba(255,255,255,.45); }
.msg-read { font-size:13px; color:var(--text3); }
.msg-read.read { color:var(--online); }
.msg-date-sep { text-align:center; color:var(--text3); font-size:13px; padding:12px 0 4px; }

/* ‚ïê‚ïê‚ïê TYPING ‚ïê‚ïê‚ïê */
.typing-area { padding:2px 20px; height:22px; font-size:13px; color:var(--text3); font-style:italic; }

/* ‚ïê‚ïê‚ïê INPUT AREA ‚ïê‚ïê‚ïê */
.input-area { padding:10px 16px; display:flex; align-items:flex-end; gap:8px; background:var(--bg2); border-top:1px solid var(--border); }
.attach-btn { background:none; border:none; color:var(--text3); font-size:22px; cursor:pointer; padding:8px; border-radius:8px; flex-shrink:0; }
.attach-btn:hover { background:var(--bg3); color:var(--accent); }
.msg-input { flex:1; padding:10px 14px; border-radius:12px; border:none; background:var(--bg1); color:var(--text1); font-size:15px; outline:none; resize:none; max-height:120px; line-height:1.4; }
.send-btn { background:var(--accent); border:none; color:#fff; font-size:18px; cursor:pointer; padding:10px; border-radius:50%; width:42px; height:42px; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:.15s; }
.send-btn:hover { background:var(--accent2); }
#file-input { display:none; }

/* ‚ïê‚ïê‚ïê UPLOAD PREVIEW ‚ïê‚ïê‚ïê */
.upload-preview { padding:8px 16px; background:var(--bg2); border-top:1px solid var(--border); display:none; align-items:center; gap:10px; }
.upload-preview.active { display:flex; }
.upload-thumb { width:48px; height:48px; border-radius:8px; object-fit:cover; }
.upload-info { flex:1; }
.upload-name { font-size:13px; font-weight:500; }
.upload-size { font-size:12px; color:var(--text3); }
.upload-cancel { background:none; border:none; color:var(--danger); cursor:pointer; font-size:20px; padding:4px; }

/* ‚ïê‚ïê‚ïê IMAGE VIEWER ‚ïê‚ïê‚ïê */
.viewer { display:none; position:fixed; inset:0; background:rgba(0,0,0,.9); z-index:100; justify-content:center; align-items:center; cursor:pointer; }
.viewer.active { display:flex; }
.viewer img { max-width:92vw; max-height:92vh; border-radius:8px; }

/* ‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê */
@media(max-width:700px) {
  .sidebar { width:100%; min-width:100%; }
  #app-screen.show-chat .sidebar { display:none; }
  #app-screen.show-chat .chat-panel { display:flex; }
  #app-screen.show-chat .no-chat { display:none; }
  .back-btn { display:block; }
  .msg { max-width:85%; }
  .msg-media { max-width:240px; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="auth-screen" class="screen active">
<div class="auth-box">
  <h1>üí¨</h1>
  <h2 id="auth-title">–í—Ö–æ–¥ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h2>
  <input class="auth-input" id="a-user" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" onkeydown="if(event.key==='Enter')document.getElementById('a-pass').focus()">
  <input class="auth-input" id="a-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')doAuth()">
  <button class="auth-btn" onclick="doAuth()" id="a-btn">–í–æ–π—Ç–∏</button>
  <div class="auth-link" onclick="toggleAuth()" id="a-link">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>
  <div class="auth-error" id="a-error"></div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app-screen" class="screen">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="side-header">
      <span class="my-name" id="my-name">üí¨ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</span>
      <button class="logout-btn" onclick="logout()" title="–í—ã–π—Ç–∏">üö™</button>
    </div>
    <div class="search-box">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input class="search-input" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="onSearch(this.value)">
      </div>
    </div>
    <div class="conv-list" id="conv-list"></div>
    <div class="search-results" id="search-results" style="display:none"></div>
  </div>

  <!-- NO CHAT SELECTED -->
  <div class="no-chat" id="no-chat">
    <div class="no-chat-icon">üí¨</div>
    <div>–í—ã–±–µ—Ä–∏ –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –Ω–∞–π–¥–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</div>
  </div>

  <!-- CHAT PANEL -->
  <div class="chat-panel" id="chat-panel">
    <div class="chat-header">
      <button class="back-btn" onclick="goBack()">‚Üê</button>
      <div class="avatar small" id="chat-avatar">A</div>
      <div class="chat-header-info">
        <div class="chat-header-name" id="chat-name">–ò–º—è</div>
        <div class="chat-header-status" id="chat-status">–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ</div>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="typing-area" id="typing-area"></div>
    <div class="upload-preview" id="upload-preview">
      <img class="upload-thumb" id="upload-thumb" src="">
      <div class="upload-info">
        <div class="upload-name" id="upload-name"></div>
        <div class="upload-size" id="upload-size"></div>
      </div>
      <button class="upload-cancel" onclick="cancelUpload()">‚úï</button>
    </div>
    <div class="input-area">
      <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
      <input type="file" id="file-input" accept="image/*,video/*,.pdf,.doc,.docx,.zip,.rar,.txt" onchange="onFileSelected(this)">
      <textarea class="msg-input" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" onkeydown="onInputKey(event)" oninput="autoResize(this);emitTyping()"></textarea>
      <button class="send-btn" onclick="sendMessage()">‚û§</button>
    </div>
  </div>
</div>

<!-- IMAGE VIEWER -->
<div class="viewer" id="viewer" onclick="this.classList.remove('active')">
  <img id="viewer-img" src="">
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let me = '';
let isRegister = false;
let currentChat = null;   // username of chat partner
let conversations = [];
let pendingFile = null;
let typingTimer = null;

const COLORS = ['#e06c75','#e5c07b','#98c379','#56b6c2','#61afef','#c678dd','#be5046','#d19a66'];
function avatarColor(name) {
  let h=0; for(let i=0;i<name.length;i++) h=name.charCodeAt(i)+((h<<5)-h);
  return COLORS[Math.abs(h)%COLORS.length];
}
function avatarLetter(name) { return name.charAt(0).toUpperCase(); }
function fmtSize(b) {
  if(b<1024) return b+' –ë';
  if(b<1048576) return (b/1024).toFixed(1)+' –ö–ë';
  return (b/1048576).toFixed(1)+' –ú–ë';
}
function fmtLastSeen(ts) {
  if(!ts) return '–±—ã–ª(–∞) –¥–∞–≤–Ω–æ';
  const d=new Date(ts), now=new Date();
  const diff=now-d;
  if(diff<60000) return '–±—ã–ª(–∞) —Ç–æ–ª—å–∫–æ —á—Ç–æ';
  if(diff<3600000) return '–±—ã–ª(–∞) '+Math.floor(diff/60000)+' –º–∏–Ω. –Ω–∞–∑–∞–¥';
  if(d.toDateString()===now.toDateString()) return '–±—ã–ª(–∞) —Å–µ–≥–æ–¥–Ω—è –≤ '+d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
  return '–±—ã–ª(–∞) '+d.toLocaleDateString('ru-RU');
}

// ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê
window.onload = () => {
  const token=localStorage.getItem('token');
  const user=localStorage.getItem('username');
  if(token&&user){ me=user; connect(token); }
};

function toggleAuth() {
  isRegister=!isRegister;
  document.getElementById('auth-title').textContent=isRegister?'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è':'–í—Ö–æ–¥ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä';
  document.getElementById('a-btn').textContent=isRegister?'–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è':'–í–æ–π—Ç–∏';
  document.getElementById('a-link').textContent=isRegister?'–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏':'–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
  document.getElementById('a-error').textContent='';
}

async function doAuth() {
  const username=document.getElementById('a-user').value.trim();
  const password=document.getElementById('a-pass').value;
  const errEl=document.getElementById('a-error');
  if(!username||!password){errEl.textContent='–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è';return;}
  try{
    const r=await fetch('/api/'+(isRegister?'register':'login'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
    const d=await r.json();
    if(d.ok){localStorage.setItem('token',d.token);localStorage.setItem('username',d.username);me=d.username;connect(d.token);}
    else{errEl.textContent=d.error;}
  }catch(e){errEl.textContent='–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';}
}

function connect(token) { socket.emit('auth', token); }

function logout() {
  localStorage.removeItem('token');localStorage.removeItem('username');
  location.reload();
}

socket.on('auth_ok', (d) => {
  me=d.username;
  document.getElementById('my-name').textContent='üë§ '+me;
  document.getElementById('auth-screen').classList.remove('active');
  document.getElementById('app-screen').classList.add('active');
});

socket.on('auth_fail', () => {
  localStorage.removeItem('token');localStorage.removeItem('username');
  document.getElementById('a-error').textContent='–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞';
  document.getElementById('auth-screen').classList.add('active');
  document.getElementById('app-screen').classList.remove('active');
});

// Reconnect
socket.on('connect', () => {
  const token=localStorage.getItem('token');
  if(token) socket.emit('auth', token);
});

// ‚ïê‚ïê‚ïê CONVERSATIONS ‚ïê‚ïê‚ïê
socket.on('conversations', (list) => {
  conversations=list;
  renderConversations();
});

function renderConversations() {
  const el=document.getElementById('conv-list');
  if(!conversations.length){el.innerHTML='<div style="padding:20px;text-align:center;color:var(--text3)">–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤.<br>–ù–∞–π–¥–∏ –∫–æ–≥–æ-–Ω–∏–±—É–¥—å —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫!</div>';return;}
  el.innerHTML=conversations.map(c => {
    const isActive=currentChat===c.username;
    let lastText='';
    if(c.lastMessage){
      const prefix=c.lastMessage.from===me?'<span class="from-me">–í—ã: </span>':'';
      if(c.lastMessage.type==='image') lastText=prefix+'üì∑ –§–æ—Ç–æ';
      else if(c.lastMessage.type==='video') lastText=prefix+'üé• –í–∏–¥–µ–æ';
      else if(c.lastMessage.type==='file') lastText=prefix+'üìÑ –§–∞–π–ª';
      else lastText=prefix+c.lastMessage.text;
    }
    return `<div class="conv-item${isActive?' active':''}" onclick="openChat('${c.username}')">
      <div class="avatar" style="background:${avatarColor(c.username)}">${avatarLetter(c.username)}${c.online?'<div class="online-dot"></div>':''}</div>
      <div class="conv-info">
        <div class="conv-top"><span class="conv-name">${c.username}</span><span class="conv-time">${c.lastMessage?c.lastMessage.time:''}</span></div>
        <div class="conv-bottom"><span class="conv-last">${lastText}</span>${c.unreadCount?'<span class="conv-unread">'+c.unreadCount+'</span>':''}</div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê
let searchTimeout;
function onSearch(q) {
  clearTimeout(searchTimeout);
  const cl=document.getElementById('conv-list');
  const sr=document.getElementById('search-results');
  if(!q.trim()){sr.style.display='none';cl.style.display='';return;}
  cl.style.display='none';
  sr.style.display='';
  searchTimeout=setTimeout(async()=>{
    const token=localStorage.getItem('token');
    try{
      const r=await fetch('/api/users/search?q='+encodeURIComponent(q),{headers:{Authorization:'Bearer '+token}});
      const users=await r.json();
      if(!users.length){sr.innerHTML='<div style="padding:20px;text-align:center;color:var(--text3)">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';return;}
      sr.innerHTML=users.map(u=>`<div class="conv-item" onclick="openChat('${u.username}');document.getElementById('search-input').value='';">
        <div class="avatar" style="background:${avatarColor(u.username)}">${avatarLetter(u.username)}${u.online?'<div class="online-dot"></div>':''}</div>
        <div class="conv-info"><div class="conv-top"><span class="conv-name">${u.username}</span></div><div class="conv-bottom"><span class="start-label">–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</span></div></div>
      </div>`).join('');
    }catch(e){}
  },300);
}

// ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê
function openChat(username) {
  currentChat=username;
  document.getElementById('search-results').style.display='none';
  document.getElementById('conv-list').style.display='';
  document.getElementById('search-input').value='';

  document.getElementById('chat-panel').classList.add('active');
  document.getElementById('no-chat').classList.add('hidden');
  document.getElementById('app-screen').classList.add('show-chat');

  document.getElementById('chat-avatar').style.background=avatarColor(username);
  document.getElementById('chat-avatar').textContent=avatarLetter(username);
  document.getElementById('chat-name').textContent=username;
  document.getElementById('chat-status').textContent='...';
  document.getElementById('messages').innerHTML='';
  document.getElementById('typing-area').textContent='';

  socket.emit('get_messages',{withUser:username});
  renderConversations();
  document.getElementById('msg-input').focus();
}

function goBack() {
  document.getElementById('app-screen').classList.remove('show-chat');
  currentChat=null;
  renderConversations();
}

socket.on('messages', (data) => {
  if(data.withUser!==currentChat) return;
  const statusEl=document.getElementById('chat-status');
  if(data.online){statusEl.textContent='–≤ —Å–µ—Ç–∏';statusEl.className='chat-header-status online';}
  else{statusEl.textContent=fmtLastSeen(data.lastSeen);statusEl.className='chat-header-status';}
  renderMessages(data.messages);
});

function renderMessages(msgs) {
  const el=document.getElementById('messages');
  el.innerHTML='';
  let lastDate='';
  msgs.forEach(m=>{
    const d=new Date(m.timestamp).toLocaleDateString('ru-RU',{day:'numeric',month:'long'});
    if(d!==lastDate){lastDate=d;const sep=document.createElement('div');sep.className='msg-date-sep';sep.textContent=d;el.appendChild(sep);}
    el.appendChild(createMsgEl(m));
  });
  el.scrollTop=el.scrollHeight;
}

function createMsgEl(m) {
  const isMine=m.from===me;
  const div=document.createElement('div');
  div.className='msg '+(isMine?'mine':'other');
  div.dataset.id=m.id;

  let mediaHTML='';
  if(m.type==='image'&&m.filePath) mediaHTML=`<img class="msg-media" src="${m.filePath}" onclick="viewImage('${m.filePath}')" loading="lazy">`;
  else if(m.type==='video'&&m.filePath) mediaHTML=`<video class="msg-video" src="${m.filePath}" controls preload="metadata"></video>`;
  else if(m.type==='file'&&m.filePath) mediaHTML=`<a class="msg-file" href="${m.filePath}" download="${m.fileName||'file'}" target="_blank"><span class="msg-file-icon">üìÑ</span><div class="msg-file-info"><div class="msg-file-name">${m.fileName||'–§–∞–π–ª'}</div><div class="msg-file-size">${m.fileSize?fmtSize(m.fileSize):''}</div></div></a>`;

  const readIcon=isMine?`<span class="msg-read${m.read?' read':''}">‚úì${m.read?'‚úì':''}</span>`:'';

  div.innerHTML=`<div class="msg-bubble">${!isMine?'':''}${mediaHTML}${m.text?'<div class="msg-text">'+m.text+'</div>':''}<div class="msg-footer"><span class="msg-time">${m.time}</span>${readIcon}</div></div>`;
  return div;
}

// ‚ïê‚ïê‚ïê SEND MESSAGE ‚ïê‚ïê‚ïê
function sendMessage() {
  const input=document.getElementById('msg-input');
  const text=input.value.trim();
  if(!currentChat) return;

  if(pendingFile){
    uploadAndSend(text);
    return;
  }

  if(!text) return;
  socket.emit('send_message',{to:currentChat,text,type:'text'});
  input.value='';
  autoResize(input);
}

async function uploadAndSend(text) {
  const token=localStorage.getItem('token');
  const form=new FormData();
  form.append('file',pendingFile);
  try{
    const r=await fetch('/api/upload',{method:'POST',headers:{Authorization:'Bearer '+token},body:form});
    const d=await r.json();
    if(d.ok){
      socket.emit('send_message',{to:currentChat,text:text||'',type:d.fileType,filePath:d.filePath,fileName:d.fileName,fileSize:d.fileSize});
    }
  }catch(e){alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');}
  cancelUpload();
  document.getElementById('msg-input').value='';
}

function onInputKey(e) {
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
}

function autoResize(el) {
  el.style.height='auto';
  el.style.height=Math.min(el.scrollHeight,120)+'px';
}

// ‚ïê‚ïê‚ïê FILE SELECT ‚ïê‚ïê‚ïê
function onFileSelected(input) {
  if(!input.files[0]) return;
  pendingFile=input.files[0];
  const prev=document.getElementById('upload-preview');
  document.getElementById('upload-name').textContent=pendingFile.name;
  document.getElementById('upload-size').textContent=fmtSize(pendingFile.size);
  const thumb=document.getElementById('upload-thumb');
  if(pendingFile.type.startsWith('image/')){thumb.src=URL.createObjectURL(pendingFile);thumb.style.display='';}
  else{thumb.style.display='none';}
  prev.classList.add('active');
  input.value='';
  document.getElementById('msg-input').focus();
}

function cancelUpload() {
  pendingFile=null;
  document.getElementById('upload-preview').classList.remove('active');
}

// ‚ïê‚ïê‚ïê DRAG & DROP ‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  const msgArea=document.getElementById('messages');
  if(!msgArea) return;
  ['dragenter','dragover'].forEach(e=>msgArea.addEventListener(e,(ev)=>{ev.preventDefault();msgArea.style.opacity='.7';}));
  ['dragleave','drop'].forEach(e=>msgArea.addEventListener(e,(ev)=>{ev.preventDefault();msgArea.style.opacity='';}));
  msgArea.addEventListener('drop',(ev)=>{
    if(ev.dataTransfer.files[0]){pendingFile=ev.dataTransfer.files[0];onFileSelected({files:[pendingFile],value:'x'});}
  });
});

// ‚ïê‚ïê‚ïê IMAGE VIEWER ‚ïê‚ïê‚ïê
function viewImage(src) {
  document.getElementById('viewer-img').src=src;
  document.getElementById('viewer').classList.add('active');
}

// ‚ïê‚ïê‚ïê INCOMING MESSAGES ‚ïê‚ïê‚ïê
socket.on('new_message', ({chatId, message}) => {
  if(message.from===currentChat||message.from===me) {
    const el=document.getElementById('messages');
    el.appendChild(createMsgEl(message));
    el.scrollTop=el.scrollHeight;
    // Mark as read if we're in this chat
    if(message.from===currentChat) {
      socket.emit('read',{chatId});
    }
  }
});

// ‚ïê‚ïê‚ïê TYPING ‚ïê‚ïê‚ïê
let typingDisplay;
socket.on('typing', ({from}) => {
  if(from===currentChat){
    document.getElementById('typing-area').textContent=from+' –ø–µ—á–∞—Ç–∞–µ—Ç...';
    clearTimeout(typingDisplay);
    typingDisplay=setTimeout(()=>{document.getElementById('typing-area').textContent='';},2500);
  }
});

function emitTyping() {
  if(!currentChat) return;
  if(typingTimer) return;
  socket.emit('typing',{to:currentChat});
  typingTimer=setTimeout(()=>{typingTimer=null;},2000);
}

// ‚ïê‚ïê‚ïê USER STATUS ‚ïê‚ïê‚ïê
socket.on('user_status', ({username, online, lastSeen}) => {
  if(username===currentChat){
    const el=document.getElementById('chat-status');
    if(online){el.textContent='–≤ —Å–µ—Ç–∏';el.className='chat-header-status online';}
    else{el.textContent=fmtLastSeen(lastSeen);el.className='chat-header-status';}
  }
  // Update conversation list avatar dot
  conversations.forEach(c=>{if(c.username===username)c.online=online;});
  renderConversations();
});

// ‚ïê‚ïê‚ïê READ RECEIPTS ‚ïê‚ïê‚ïê
socket.on('messages_read', ({chatId, by}) => {
  if(by===currentChat){
    document.querySelectorAll('.msg.mine .msg-read').forEach(el=>{el.className='msg-read read';el.textContent='‚úì‚úì';});
  }
});

// ‚ïê‚ïê‚ïê PWA ‚ïê‚ïê‚ïê
if('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});
</script>
</body>
</html>